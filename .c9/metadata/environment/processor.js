{"filter":false,"title":"processor.js","tooltip":"/processor.js","undoManager":{"mark":0,"position":0,"stack":[[{"start":{"row":0,"column":0},"end":{"row":66,"column":2},"action":"insert","lines":["// processor.js","const AWS = require('aws-sdk');","const s3 = new AWS.S3();","const dynamodb = new AWS.DynamoDB.DocumentClient();","const { createThumbnail } = require('./imageProcessor');","const { extractText } = require('./textExtractor');","","async function processFile(record) {","    const { fileId, s3Key } = record.dynamodb.NewImage;","    ","    try {","        // Atualizar status para PROCESSING","        await updateStatus(fileId.S, 'PROCESSING');","        ","        // Baixar arquivo do S3","        const file = await s3.getObject({","            Bucket: process.env.UPLOAD_BUCKET,","            Key: s3Key.S","        }).promise();","        ","        let result;","        if (file.ContentType.startsWith('image/')) {","            result = await createThumbnail(file.Body);","            await s3.putObject({","                Bucket: process.env.UPLOAD_BUCKET,","                Key: `thumbnails/${fileId.S}.jpg`,","                Body: result.thumbnail","            }).promise();","        } else {","            result = await extractText(file.Body);","        }","        ","        // Atualizar status e resultados","        await updateStatus(fileId.S, 'COMPLETED', result);","        ","    } catch (error) {","        console.error('Processing error:', error);","        await updateStatus(fileId.S, 'FAILED', { error: error.message });","    }","}","","async function updateStatus(fileId, status, result = {}) {","    const params = {","        TableName: process.env.METADATA_TABLE,","        Key: { fileId },","        UpdateExpression: 'set #status = :s, processedAt = :p, #result = :r',","        ExpressionAttributeNames: {","            '#status': 'status',","            '#result': 'result'","        },","        ExpressionAttributeValues: {","            ':s': status,","            ':p': new Date().toISOString(),","            ':r': result","        }","    };","    ","    await dynamodb.update(params).promise();","}","","exports.handler = async (event) => {","    for (const record of event.Records) {","        if (record.eventName === 'INSERT') {","            await processFile(record);","        }","    }","};"],"id":1}]]},"ace":{"folds":[],"scrolltop":518.4000282505597,"scrollleft":0,"selection":{"start":{"row":66,"column":2},"end":{"row":66,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":42,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1744493109218,"hash":"0b7c70afd567fa8916561472b86ff3422953377a"}